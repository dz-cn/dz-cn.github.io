
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <title>MySQL 的锁 | 独酌的博客</title>
    <meta name="author" content="dz.cn" />
    <meta name="description" content="这是总的 description" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.jpg" />

    <!--引入对应内容的js文件-->
    <link rel="preconnect" href="https://s4.zstatic.net"/>
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
<link rel="preconnect" href="https://fonts.googleapis.cn"/>
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin/>
<link
        rel="stylesheet"
        href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

    <script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


    <script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
    <link
            rel="stylesheet"
            href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
    />
    <script src="/js/lib/highlight.js"></script>


    <script src="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
    <script src="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
    <link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.css"/>
    <script src="/js/lib/math.js"></script>


    <script src="/js/lib/preview.js"></script>




    
    
    


<link rel="stylesheet" href="/css/main.css"/>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="generator" content="Hexo 8.0.0"></head>
<body>
    <div id="layout">
        <!--加载动画-->
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>加载中...</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>独酌的博客</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;主页</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;文章</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;类型</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;标签</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;独酌的博客</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">主页</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">文章</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">类型</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">标签</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>


        <!--主体-->
        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <!--当前要渲染的内容-->
            <div class="article">
    <!--文章标题-->
    <div>
        <h1>MySQL 的锁</h1>
    </div>

    <!--每篇文章开头的信息-->
    <div class="info">
        <!--日期-->
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2025/10/25
        </span>
        <!--判断是否有分类-->
        
        <span class="category">
            
            <a href="/categories/MySQL-%E5%AD%A6%E4%B9%A0/" style="color: #ffa2c4">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                MySQL 学习
            </a>
        </span>
        
        <!--判断是否有标签-->
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            <span class="tag">
                
                <a href="/tags/MySQL/" style="color: #26a69a">
                    MySQL
                </a>
            </span>
            
        </span>
        

        <!--本文的阅读量-->
        <span style="margin-right: 15px">
            <span class="icon">
                <i class="fa-solid fa-eye"></i>
            </span>
            <span id="busuanzi_container_page_pv">
                <span id="busuanzi_value_page_pv"></span>
            </span>
        </span>

        <br>
        <!--本文的字数统计-->
        <span style="margin-right: 15px;">
            <span class="icon">
                <i class="fa-solid fa-pen"></i>
            </span>
            <span>2507 字 | 0 代码块</span>
        </span>
    </div>

    <!--加密配置，如果启用加密，这执行加密逻辑-->
    
    <div class="content" v-pre>
        <h3 id="1、锁的分类"><a href="#1、锁的分类" class="headerlink" title="1、锁的分类"></a>1、锁的分类</h3><ul>
<li>全局锁：锁住整个数据库，也就是锁住数据库中所有的表。</li>
<li>表级锁：锁住整张表。</li>
<li>行级锁：锁住单独的一行数据。</li>
</ul>
<h3 id="2、全局锁"><a href="#2、全局锁" class="headerlink" title="2、全局锁"></a>2、全局锁</h3><h4 id="2-1-全局锁的分类和作用"><a href="#2-1-全局锁的分类和作用" class="headerlink" title="2.1 全局锁的分类和作用"></a>2.1 全局锁的分类和作用</h4><p>​		MySQL全局锁是针对整个数据库的锁。最常用的全局锁是读锁和写锁。</p>
<ul>
<li>读锁（共享锁）：它阻止其他用户更新数据，但允许他们读取数据。</li>
<li>写锁（排他锁）：它阻止其他用户读取和更新数据。</li>
</ul>
<h4 id="2-2-全局锁的用法"><a href="#2-2-全局锁的用法" class="headerlink" title="2.2 全局锁的用法"></a>2.2 全局锁的用法</h4><ul>
<li><code>FLUSH TABLES WITH READ/WRITE LOCK(FTWRL)</code>：用来锁住整个数据库</li>
<li><code>UNLOCK TABLES</code> ：进行解锁</li>
</ul>
<h4 id="2-3-全局锁的使用场景"><a href="#2-3-全局锁的使用场景" class="headerlink" title="2.3 全局锁的使用场景"></a>2.3 全局锁的使用场景</h4><ul>
<li><strong>备份全库</strong>：使用全局锁可以确保在备份过程中，数据库的所有表都保持一致的状态。</li>
<li><strong>整体数据迁移</strong>：将整个数据库从一个服务器迁移到另一个服务器，需要阻止任何写操作，以确保所有的数据都被正确地迁移到新的服务器。</li>
<li><strong>全库只读</strong>：在某些情况下，可能希望将整个数据库设置为只读模式。</li>
</ul>
<h3 id="3、表级锁"><a href="#3、表级锁" class="headerlink" title="3、表级锁"></a>3、表级锁</h3><h4 id="3-1-表级锁的分类"><a href="#3-1-表级锁的分类" class="headerlink" title="3.1 表级锁的分类"></a>3.1 表级锁的分类</h4><ul>
<li><p>表锁</p>
</li>
<li><p>元数据锁</p>
</li>
<li><p>意向锁</p>
<blockquote>
<p>​        这里可能会疑惑为什么有表锁、意向锁、元数据锁会<strong>处于同一层级</strong>，不应该是表锁包含元数据锁和意向锁吗，这里其实陷入了一个误区，其实，表锁、意向锁、元数据锁 都属于 表<strong>级</strong>锁，而表<strong>级</strong>锁当然包括了表锁，同时，元数据锁和意向锁也都属于表<strong>级</strong>锁，同样，行锁和行<strong>级</strong>锁也是同样的道理，后面就不赘述了。</p>
</blockquote>
</li>
</ul>
<h4 id="3-2-表锁"><a href="#3-2-表锁" class="headerlink" title="3.2 表锁"></a>3.2 表锁</h4><h5 id="3-2-1-表锁的概念和分类"><a href="#3-2-1-表锁的概念和分类" class="headerlink" title="3.2.1 表锁的概念和分类"></a>3.2.1 表锁的概念和分类</h5><p>​		表锁是<strong>最基础的表级锁</strong>，直接对整个表进行锁定，分为<strong>读锁和写锁</strong>，二者遵循 “读共享、写独占” 原则。</p>
<ul>
<li><strong>读锁（Shared Lock，简称 S 锁）</strong>：事务加读锁后，自身和其他事务只能读表，不能修改表数据。多个事务可同时对同一表加读锁，互不阻塞。</li>
<li><strong>写锁（Exclusive Lock，简称 X 锁）</strong>：事务加写锁后，只有自身能读写表数据，其他事务无法加读锁或写锁，也不能查询或者修改数据，会被阻塞直到当前事务的写锁释放。</li>
</ul>
<h5 id="3-2-2-表锁的用法"><a href="#3-2-2-表锁的用法" class="headerlink" title="3.2.2 表锁的用法"></a>3.2.2 表锁的用法</h5><ul>
<li>加锁：<code>lock tables 表名... read/write</code></li>
<li>解锁：<code>unlock tables 或者 客户端连接断开</code></li>
</ul>
<h5 id="3-2-3-与MyISAM-存储引擎的关联"><a href="#3-2-3-与MyISAM-存储引擎的关联" class="headerlink" title="3.2.3 与MyISAM 存储引擎的关联"></a>3.2.3 与MyISAM 存储引擎的关联</h5><p>​		由于MyISAM 引擎不支持行锁，所有操作都依赖表锁，且默认会在<code>select</code>时隐式加读锁、<code>insert/update/delete</code>时隐式加写锁并自动释放。</p>
<h4 id="3-3-元数据锁"><a href="#3-3-元数据锁" class="headerlink" title="3.3 元数据锁"></a>3.3 元数据锁</h4><h5 id="3-3-1-元数据锁的概念和分类"><a href="#3-3-1-元数据锁的概念和分类" class="headerlink" title="3.3.1 元数据锁的概念和分类"></a>3.3.1 元数据锁的概念和分类</h5><p>​		<strong>元数据锁（Metadata Lock，简称 MDL）<code>MDL</code> 不锁定数据本身，而是</strong>保护表的元数据（如表结构、字段类型、索引信息等），避免 “表结构修改” 与 “数据读写” 同时进行导致的不一致。</p>
<ul>
<li><strong>共享 MDL 锁（Shared MDL）</strong>：事务执行查询（如<code>SELECT</code>）时自动加共享 <code>MDL</code> 锁，多个事务可同时加，互不影响。</li>
<li><strong>排他 MDL 锁（Exclusive MDL）</strong>：事务执行表结构修改（如<code>ALTER TABLE</code>、<code>DROP COLUMN</code>）时自动加排他 MDL锁，加锁期间会阻塞所有其他事务的共享 <code>MDL</code> 锁请求。</li>
</ul>
<h4 id="3-4-意向锁"><a href="#3-4-意向锁" class="headerlink" title="3.4 意向锁"></a>3.4 意向锁</h4><h5 id="3-4-1-意向锁的概念和分类"><a href="#3-4-1-意向锁的概念和分类" class="headerlink" title="3.4.1 意向锁的概念和分类"></a>3.4.1 意向锁的概念和分类</h5><p>​		意向锁是 “中间层锁”，作用是<strong>快速判断表内是否存在行级锁</strong>，避免表锁与行锁的冲突检查需要遍历所有行，提升效率。它仅标识 “意向”，不直接阻止数据读写。</p>
<ul>
<li><strong>意向共享锁（Intention Shared Lock，简称 IS 锁）</strong>：事务计划对表中某些行加读锁（行级 <code>S</code> 锁）前，会先对表加 <code>IS</code> 锁。</li>
<li><strong>意向排他锁（Intention Exclusive Lock，简称 IX 锁）</strong>：事务计划对表中某些行加写锁（行级 <code>X</code> 锁）前，会先对表加 <code>IX</code> 锁。</li>
</ul>
<h5 id="3-4-2-意向锁的执行过程"><a href="#3-4-2-意向锁的执行过程" class="headerlink" title="3.4.2 意向锁的执行过程"></a>3.4.2 意向锁的执行过程</h5><p>​		<strong>原来</strong>：当执行根据 <code>id</code> 更新数据库表中的某一行数据时，会在这一行加上行锁，但是当另一个客户端需要加表锁的时候，会逐行检查是否有行锁的存在。效率极低。</p>
<p>​		<strong>现在</strong>(有了意向锁后)：当加行锁的时候，<strong>同时会给这张表加上意向锁</strong>，当另一个客户端需要加表锁的时候，就会先去检查这个意向锁<strong>是否与自己要获取的锁兼容</strong>，如果兼容，获取锁成功，如果不兼容，获取锁失败。</p>
<h3 id="4、行级锁"><a href="#4、行级锁" class="headerlink" title="4、行级锁"></a>4、行级锁</h3><h4 id="4-1-行级锁的分类"><a href="#4-1-行级锁的分类" class="headerlink" title="4.1 行级锁的分类"></a>4.1 行级锁的分类</h4><ul>
<li>行锁</li>
<li>间隙锁</li>
<li>临键锁</li>
</ul>
<h4 id="4-2-行锁"><a href="#4-2-行锁" class="headerlink" title="4.2 行锁"></a>4.2 行锁</h4><h5 id="4-2-1-行锁的概念和分类"><a href="#4-2-1-行锁的概念和分类" class="headerlink" title="4.2.1 行锁的概念和分类"></a>4.2.1 行锁的概念和分类</h5><p>​		行锁是最基础的行级锁，<strong>直接锁定表中某一行记录</strong>，仅对锁定的行生效，不影响其他行。</p>
<ul>
<li>共享锁（<code>S</code> 锁）：事务对某行加 <code>S</code> 锁后，自身可读该行，其他事务可加 <code>S</code> 锁（共享读），但不能加 <code>X</code> 锁（阻塞写）。</li>
<li>排他锁（<code>X</code> 锁）：事务对某行加 <code>X</code> 锁后，自身可读写该行，其他事务既不能加 <code>S</code> 锁也不能加 <code>X</code> 锁（读写都阻塞）。</li>
</ul>
<h5 id="4-2-2-行锁的特点"><a href="#4-2-2-行锁的特点" class="headerlink" title="4.2.2 行锁的特点"></a>4.2.2 行锁的特点</h5><p>​		仅锁定具体行，粒度最细，并发影响最小，但加锁 &#x2F; 释放锁开销略高于表锁。行锁必须<strong>基于索引生效</strong>，若查询未使用索引（进行的是全表扫描），InnoDB 会退化为表锁（意向锁 + 表锁）。</p>
<h4 id="4-3-间隙锁"><a href="#4-3-间隙锁" class="headerlink" title="4.3 间隙锁"></a>4.3 间隙锁</h4><h5 id="4-3-1-间隙锁的概念"><a href="#4-3-1-间隙锁的概念" class="headerlink" title="4.3.1 间隙锁的概念"></a>4.3.1 间隙锁的概念</h5><p>​		间隙锁是<strong>锁定索引记录之间的 “间隙”</strong>，不锁定具体行，仅防止其他事务在间隙中插入新记录，解决 “幻读” 问题（RR 隔离级别下生效）。</p>
<h5 id="4-3-2-什么是间隙"><a href="#4-3-2-什么是间隙" class="headerlink" title="4.3.2 什么是间隙"></a>4.3.2 什么是间隙</h5><p>​		指索引值之间的空白区间。例如，表中某索引列存在值<code>10、20、30</code>，则间隙包括：<code>(-∞, 10)</code>、<code>(10, 20)</code>、<code>(20, 30)</code>、<code>(30, +∞)</code>。</p>
<h5 id="4-3-3-间隙锁的作用"><a href="#4-3-3-间隙锁的作用" class="headerlink" title="4.3.3 间隙锁的作用"></a>4.3.3 间隙锁的作用</h5><p>​		阻止在间隙中插入新行。例如，事务 A 对<code>(10, 20)</code>加间隙锁后，其他事务无法插入<code>15</code>（属于该间隙），但可以修改已存在的<code>10、20</code>（如果没被行锁锁定）。</p>
<h5 id="4-3-4-间隙锁的触发场景"><a href="#4-3-4-间隙锁的触发场景" class="headerlink" title="4.3.4 间隙锁的触发场景"></a>4.3.4 间隙锁的触发场景</h5><p>​		在 RR 隔离级别下，使用非唯一索引或范围查询（如<code>WHERE id &gt; 10 AND id &lt; 20</code>）时，InnoDB 会对匹配不到行的范围加间隙锁。</p>
<blockquote>
<p>注意：间隙锁之间不冲突（多个事务可同时对同一间隙加间隙锁）。</p>
</blockquote>
<h4 id="4-4-临键锁"><a href="#4-4-临键锁" class="headerlink" title="4.4 临键锁"></a>4.4 临键锁</h4><h5 id="4-4-1-临键锁的概念"><a href="#4-4-1-临键锁的概念" class="headerlink" title="4.4.1 临键锁的概念"></a>4.4.1 临键锁的概念</h5><p>​		临键锁是<strong>行锁与间隙锁的组合</strong>，是 InnoDB 在 RR 隔离级别下默认的行级锁类型，既锁定具体行，也锁定该行前面的间隙。</p>
<h5 id="4-4-2-临键锁的作用"><a href="#4-4-2-临键锁的作用" class="headerlink" title="4.4.2 临键锁的作用"></a>4.4.2 临键锁的作用</h5><p>​		临键锁主要用来防止两种冲突</p>
<ul>
<li>其他事务修改锁定的行（行锁的作用）。</li>
<li>其他事务在锁定的间隙中插入新行（间隙锁的作用）。</li>
</ul>
<h5 id="4-4-3-临键锁的触发场景"><a href="#4-4-3-临键锁的触发场景" class="headerlink" title="4.4.3 临键锁的触发场景"></a>4.4.3 临键锁的触发场景</h5><p>​		在 RR 隔离级别下，使用<strong>非唯一索引进行等值查询或范围查询</strong>时，若命中行，InnoDB 会对该行加行锁，同时对该行左侧的间隙加间隙锁，<strong>组合为临键锁</strong>。</p>

    </div>
    

    <!--如果启用文章的评论，显示评论逻辑-->
    
    
    
    
    
    
</div>


            <!--页脚内容-->
            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy; 2025 - 2025 独酌的博客
            <i class="fa-solid fa-font-awesome fa-fw"></i>
            <a href= "http://example.com">&commat;dz.cn</a>
            <br>
            总访问量 <span id="busuanzi_value_site_pv"></span> 次 | 总访客数 <span id="busuanzi_value_site_uv"></span> 人次
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>
        </div>

        <!--图片预览-->
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>

    <script src="/js/main.js"></script>
    <!--评论的显示-->
    
    




    
</body>
</html>
