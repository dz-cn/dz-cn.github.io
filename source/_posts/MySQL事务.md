---
title: MySQL事务
tags:
  - 事务
description: |
  文章缩略，支持 `Markdown` **文档格式**
pinned: 0
lang: zh
categories:
  - MySQL 篇
type: post
wordCount: 65
charCount: 1580
imgCount: 0
vidCount: 0
wsCount: 0
cbCount: 0
readTime: 约30秒
date: 2025-10-28 16:31:28
---
### 1、事务的ACID模型

1、**原子性**：是最小分割的操作单元，要么全部成功，要么全部失败。

2、**一致性**：事务完成时，必须使所有的数据都保持一致，即：事务前后数据的完整性和一致性。

3、**隔离性**：数据库系统提供的隔离机制，通过不同的隔离级别，保证事务在不受外部并发操作影响的独立环境下运行。

4、**持久性**：事务一旦提交或回滚，它对数据库中的数据的改变就是永久的，即使机器发生故障，也可以通过日志等方式恢复数据。

### 2、并发下的事务问题

1、**脏读**：一个事务读取到另一个事务还没有提交的数据。

2、**不可重复读**：一个事务先后读取同一条记录，但是两次读取的数据不同。

3、**幻读**：在**解决**不可重复度的前提下，一个事务按照条件查询数据时，没有对应的数据行，但是在插入数据时，又发现这行数据已经存在，好像出现了一个幻影，再次查询又查不到，因为已经解决了不可重读的问题，因此会出现幻读的问题。前后两次查询的数据不一致，第二次查到了第一次不存在的数据。

### 4、事务的隔离级别(解决并发事务的问题)：

1、`Read uncommitted` ：什么都不能解决。（读未提交，可以读到其他事务尚未提交的数据）

2、`Read committed` ：只能解决脏读。（读已提交，只读其他事务已经提交的数据，不能读取未提交的更改，原因就是：在读取数据时加入了共享锁，但是，只是在读取时暂时，在事务提交或回滚后，就会释放锁，从而解决脏读问题）

3、`Repeatable Read(默认)` ：只解决脏读、不可重复读。（会在整个事务期间持有锁，解决脏读和不可重复读）

4、`Serializable` ：所有的都能解决。（加范围锁，会对查询的范围加锁，并且事务会按照一定的顺序排队执行，不会出现并发问题）

### 5、事务的原理

##### 1、基本概述

- 原子性、一致性、持久性：是通过底层的两个日志文件来实现的，redo log 、undo log
- 隔离性：是通过锁机制和MVCC(多版本并发控制)来实现的。

##### 2、详细解释

- **持久性**
    - 利用 `redo log` 实现。重做日志，记录事务提交时的数据**物理页**修改，即，`redo log`记录的是，**某个页的某个数据从什么值变成什么值**。
    - 该日志主要分为两个部分
        - **重做缓冲日志**：`redo log buffer`，存在于内存中，记录事务提交时的物理修改。
        - **重做日志文件**：`redo log file`，存在于磁盘中。
    - **过程**：当对缓冲区的数据进行增删改之后，会首先将**数据页的变化**记录到`redo log buffer` 中，在事务提交后，会**直接**将`redo log buffer` 中的数据刷新到磁盘文件中，之后在**脏页刷新**的时候出错了，就可以通过`redo log file`来进行恢复。
    - **注意**：为什么不在提交事务的时候直接将脏页刷新到磁盘，而是通过 `redo log`来实现，因为，直接刷新存在**严重的性能问题**因为一个事务中，一定包含很多条语句，每条语句的数据不一定相同，会涉及到**很多随机磁盘IO**，而`log`都是追加的，因此是**顺序磁盘IO**，顺序 IO 的效率大于随机 IO
- **原子性**
    - `undo log`用于**回滚日志**，记录数据被修改前的信息，作用包含两个：提供回滚和`MVCC`(多版本并发控制)
    - `undo log`是逻辑日志。可以认为当 `delete` 一条记录时，`undo log` 会记录一条对应的 insert 记录，反之亦然，当`update`一条记录时，他记录一条对应相反的`update`记录。当执行`rollback`时，就可以从`undo log` 中的逻辑记录中读取到相应的内容，并进行回滚，**从而保证数据的原子性(主要时回滚)**，实际上就是记录的是**旧版本的数据**。
        - `Undo log`销毁：`undo log` 在事务执行时产生,，事务提交时，并不会立即删除，因为这些事务有肯能涉及到MVCC
        - `Undo log`存储：`undo log`采用段的方式进行回滚和记录，存放在`rollback`、`segment` 回滚段中。